<form action="/search/results" method="get" class="search-form">
  <div class="search-row">
    <input type="text" name="q" minlength="2" required placeholder="Search across all categories..." value="<%= typeof q !== 'undefined' ? q : '' %>" class="search-input" />
    <button type="submit" class="search-button">Search</button>
  </div>
  <div class="filter-row">
    <div class="categories-label">
      <label for="types" class="filter-label">Categories:</label>
    </div>
    <select name="types[]" id="types" multiple class="filter-select">
      <option value="users" <%=!types || types.includes('users') ? 'selected' : '' %>>Users</option>
      <option value="stories" <%=!types || types.includes('stories') ? 'selected' : '' %>>Stories</option>
      <option value="collections" <%=!types || types.includes('collections') ? 'selected' : '' %>>Collections</option>
      <option value="comments" <%=!types || types.includes('comments') ? 'selected' : '' %>>Comments</option>
      <option value="chapters" <%=!types || types.includes('chapters') ? 'selected' : '' %>>Chapters</option>
    </select>
  </div>
</form>

<% if (typeof results !== 'undefined') { %>
<% const activeCats = ['users','stories','collections','comments','chapters'].filter(cat =>
        Array.isArray(results[cat]) && results[cat].length);
        %>
<% if (activeCats.length) { %>
<div class="search-results">
  <div class="tabs">
    <% activeCats.forEach((category, i) => { %>
    <button class="tab-btn <%= i === 0 ? 'active' : '' %>" data-tab="<%= category %>">
      <%= category.charAt(0).toUpperCase() + category.slice(1) %>
    </button>
    <% }) %>
  </div>
  <% activeCats.forEach((category, i) => { %>
  <section class="results-section <%= i === 0 ? 'active' : '' %>" data-tab-content="<%= category %>">
    <ul>
      <% results[category].forEach(item => { %>
      <li>
        <% if (category === 'users') { %>
        <a href="/users/<%= item.username %>">
          <%= item.username %>
        </a>
        <% } else if (category === 'stories') { %>
        <a href="/story/<%= item.author_username %>/<%= item.story_vanity %>">
          <%= item.title %>
        </a>
        <% } else if (category === 'collections') { %>
        <a href="/collections/<%= item.owner_username %>/<%= item.id %>">
          <%= item.title %>
        </a>
        <% } else if (category === 'comments') { %>
        <a href="/story/<%= item.story_author_username %>/<%= item.story_vanity %>/chapter/<%= item.chapter_num %>#comment-<%= item.id %>">
          <%= item.story_author_username %>: <%= item.content %>
        </a>
        <% } else if (category === 'chapters') { %>
        <a href="/story/<%= item.story_author_username %>/<%= item.story_vanity %>/chapter/<%= item.chapter_num %>">
          <%= item.title %>
        </a>
        <% } %>
      </li>
      <% }) %>
    </ul>
  </section>
  <% }) %>
</div>
<% } else { %>
<p>No results found in any category.</p>
<% } %>
<% } %>

<script>
  setHeading("Universal Search", "Searches titles, usernames and chapter/comment content");
  $('#types').select2({
    placeholder: 'Select categories',
    allowClear: true,
    width: 'resolve'
  });
  document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', () => {
      const tab = button.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      document.querySelectorAll('.results-section').forEach(sec => {
        sec.classList.toggle('active', sec.dataset.tabContent === tab);
      });
    });
  });
</script>