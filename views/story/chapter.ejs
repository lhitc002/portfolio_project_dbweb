<% function timeAgo(date) { const now=new Date(); const diff=Math.floor((now - new Date(date)) / 1000); if (diff < 60)
    return `${diff} second${diff !==1 ? 's' : '' } ago`; const minutes=Math.floor(diff / 60); const seconds=diff % 60;
    if (minutes < 60) return `${minutes} minute${minutes !==1 ? 's' : '' }, ${seconds} second${seconds !==1 ? 's' : '' }
    ago`; const hours=Math.floor(minutes / 60); const mins=minutes % 60; if (hours < 24) return `${hours} hour${hours
    !==1 ? 's' : '' }, ${mins} minute${mins !==1 ? 's' : '' } ago`; const days=Math.floor(hours / 24); if (days < 30)
    return `${days} day${days !==1 ? 's' : '' } ago`; const months=Math.floor(days / 30); const remDays=days % 30;
    return `${months} month${months !==1 ? 's' : '' }${remDays ? `, ${remDays} day${remDays !==1 ? 's' : '' }` : '' }
    ago`; } function formatRawDate(date) { const d=new Date(date); const datePart=d.toLocaleDateString(); const
    timePart=d.toLocaleTimeString([], { hour: '2-digit' , minute: '2-digit' , second: '2-digit' }); return `${datePart}
    ${timePart}`; } %>

    <div class="chapter-reader">
        <div class="chapter-header">
            <div class="breadcrumb">
                <a href="/story">Stories</a> &gt;
                <a href="/story/<%= story.user_id %>/<%= story.id %>">
                    <%= story.title %>
                </a> &gt;
                Chapter <%= chapter.chapter_num %>
            </div>

            <h1>
                <% if (chapter.title) { %>
                    <%= chapter.title %>
                        <% } else { %>
                            Chapter <%= chapter.chapter_num %>
                                <% } %>
            </h1>
            <p class="story-title">from <strong>
                    <%= story.title %>
                </strong> by <%= story.username %>
            </p>
        </div>

        <div class="chapter-navigation">
            <% if (prevChapter) { %>
                <a href="/story/<%= story.user_id %>/<%= story.id %>/chapter/<%= prevChapter.chapter_num %>"
                    class="nav-button prev">
                    ← Previous Chapter
                </a>
                <% } %>

                    <a href="/story/<%= story.user_id %>/<%= story.id %>" class="nav-button contents">
                        Table of Contents
                    </a>

                    <% if (nextChapter) { %>
                        <a href="/story/<%= story.user_id %>/<%= story.id %>/chapter/<%= nextChapter.chapter_num %>"
                            class="nav-button next">
                            Next Chapter →
                        </a>
                        <% } %>
        </div>

        <div class="chapter-content">
            <%- chapter.formattedContent %>
        </div>

        <div class="chapter-navigation">
            <% if (prevChapter) { %>
                <a href="/story/<%= story.user_id %>/<%= story.id %>/chapter/<%= prevChapter.chapter_num %>"
                    class="nav-button prev">
                    ← Previous Chapter
                </a>
                <% } %>

                    <a href="/story/<%= story.user_id %>/<%= story.id %>" class="nav-button contents">
                        Table of Contents
                    </a>

                    <% if (nextChapter) { %>
                        <a href="/story/<%= story.user_id %>/<%= story.id %>/chapter/<%= nextChapter.chapter_num %>"
                            class="nav-button next">
                            Next Chapter →
                        </a>
                        <% } %>
        </div>

        <div class="chapter-info">
            <p>Published: <%= new Date(chapter.created_at).toLocaleDateString() %>
            </p>
        </div>

        <% if (comments && comments.length> 0) { %>
            <div class="comments-section">
                <h3>Comments</h3>
                <% comments.forEach(comment=> { %>
                    <div class="comment">
                        <div class="comment-header">
                            <strong>
                                <%= comment.username %>
                            </strong>
                            <span class="comment-date" title="<%= formatRawDate(comment.created_at) %>">
                                <%= timeAgo(comment.created_at) %>
                            </span>
                        </div>
                        <div class="comment-content">
                            <%= comment.content %>
                        </div>
                    </div>
                    <% }) %>
            </div>
            <% } %>
    </div>