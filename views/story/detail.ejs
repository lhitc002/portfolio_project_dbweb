<div class="story-detail">
  <h1>
    <%= story.title %>
  </h1>
  <p class="author">by <strong>
      <a href="/users/<%= story.username %>"><%= story.username %></a>
    </strong></p>

  <% if (story.synopsis) { %>
  <div class="synopsis">
    <h3>Synopsis</h3>
    <p>
      <%= story.synopsis %>
    </p>
  </div>
  <% } %>

  <div class="story-stats">
    <% if (story.avg_rating) { %>
    <span class="rating">Rating: â˜… <%= Number(story.avg_rating).toFixed(1) %> (<%= story.rating_count %>
      reviews)</span>
    <% } %>
    <span class="created">Created: <%= new Date(story.created_at).toLocaleDateString() %></span>
    <span class="updated">Last Updated: <%= new Date(story.updated_at).toLocaleDateString() %>
    </span>
  </div>

  <% if (session.userId === story.user_id) { %>
  <div class="story-actions button-group">
    <a href="/story/<%= story.username %>/<%= story.vanity %>/edit" class="btn btn-secondary">Edit Story</a>

    <a href="#" class="btn btn-secondary" onclick="event.preventDefault(); if (confirm('Delete this story?')) { document.getElementById('delete-form').submit(); }">
      Delete Story
    </a>

    <form id="delete-form" action="/story/<%= story.username %>/<%= story.vanity %>/delete" method="POST" style="display: none;"></form>
  </div>

  <% } %>

  <div class="chapters">
    <h3>Chapters</h3>

    <% if (session.userId === story.user_id) { %>
    <a href="/story/<%= story.username %>/<%= story.vanity %>/chapter/add" class="btn btn-primary mb-2">Add Chapter</a>
    <% } %>

    <% if (chapters && chapters.length > 0) { %>
    <ol class="chapter-list">
      <% chapters.forEach(chapter => { %>
      <li>
        <a href="/story/<%= story.username %>/<%= story.vanity %>/chapter/<%= chapter.chapter_num %>">
          <% if (chapter.title) { %>
          Chapter <%= chapter.chapter_num %>: <%= chapter.title %>
          <% } else { %>
          Chapter <%= chapter.chapter_num %>
          <% } %>
        </a>
        <span class="chapter-date">
          <%= new Date(chapter.created_at).toLocaleDateString() %>
        </span>

        <% if (session.userId === story.user_id) { %>
        <span class="chapter-actions" style="margin-left: 10px;">
          <a href="/story/<%= story.username %>/<%= story.vanity %>/chapter/<%= chapter.chapter_num %>/edit" class="btn btn-sm btn-secondary">Edit</a>

          <a href="#" class="btn btn-sm btn-secondary" onclick="event.preventDefault(); if (confirm('Delete this chapter?')) { document.getElementById('delete-chapter-<%= chapter.chapter_num %>').submit(); }">
            Delete
          </a>

          <form id="delete-chapter-<%= chapter.chapter_num %>" action="/story/<%= story.username %>/<%= story.vanity %>/chapter/<%= chapter.chapter_num %>/delete" method="POST" style="display: none;"></form>
        </span>
        <% } %>
      </li>
      <% }) %>
    </ol>
    <% } else { %>
    <p>No chapters available yet.</p>
    <% } %>
  </div>
</div>