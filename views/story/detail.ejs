<div class="story-detail">
  <h1>
    <%= story.title %>
  </h1>
  <p class="author">by <strong>
      <a href="../users/<%= story.username %>"><%= story.username %></a>
    </strong></p>

  <% if (story.synopsis) { %>
  <div class="synopsis">
    <h3>Synopsis</h3>
    <p>
      <%= story.synopsis %>
    </p>
  </div>
  <% } %>

  <div class="story-stats">
    <% if (story.avg_rating) { %>
    <span class="rating">Rating: ★ <%= Number(story.avg_rating).toFixed(1) %> (<%= story.rating_count %>
      reviews)</span>
    <% } %>
    <span class="created">Created: <%= new Date(story.created_at).toLocaleDateString() %></span>
    <span class="updated">Last Updated: <%= new Date(story.updated_at).toLocaleDateString() %>
    </span>
  </div>

  <% if (session.userId && session.userId !== story.user_id) { %>
  <form action="../story/<%= story.username %>/<%= story.vanity %>/rate" method="POST" class="user-rating" aria-label="Rate story">
    <h3 style="display:inline-block; margin-right:1rem;">Your Rating</h3>
    <div class="star-rating" role="radiogroup" aria-label="Star rating" style="display:inline-flex; align-items:center;">
      <% for (let i = 5; i >= 1; i--) { %>
      <button type="button" class="star" data-value="<%= i %>" aria-checked="<%= userRating === i ? 'true' : 'false' %>" role="radio" tabindex="0" style="background:none; border:none; font-size:2rem; color:<%= userRating >= i ? '#ffc107' : '#ddd' %>; cursor:pointer;">★</button>
      <% } %>
    </div>
    <input type="hidden" name="rating" id="rating-value" value="<%= userRating || '' %>">
    <button type="submit" class="btn btn-primary" style="margin-left:1rem;">
      <%= userRating ? 'Update Rating' : 'Submit Rating' %>
    </button>
    <button type="button" id="clear-rating" class="btn btn-secondary" style="margin-left:0.5rem;">Clear Rating</button>
  </form>

  <script>
    const stars = document.querySelectorAll('.star-rating .star');
    const ratingInput = document.getElementById('rating-value');
    const clearBtn = document.getElementById('clear-rating');

    stars.forEach(star => {
      star.addEventListener('click', () => {
        const val = star.getAttribute('data-value');
        ratingInput.value = val;
        stars.forEach(s => {
          s.setAttribute('aria-checked', 'false');
          s.style.color = '#ddd';
        });
        stars.forEach(s => {
          if (s.getAttribute('data-value') <= val) s.style.color = '#ffc107';
        });
        star.setAttribute('aria-checked', 'true');
      });
    });

    clearBtn.addEventListener('click', () => {
      ratingInput.value = '';
      stars.forEach(s => {
        s.setAttribute('aria-checked', 'false');
        s.style.color = '#ddd';
      });
      ratingInput.form.submit();
    });

    // On load, highlight stars based on userRating
    const currentRating = ratingInput.value;
    if (currentRating) {
      stars.forEach(s => {
        if (s.getAttribute('data-value') <= currentRating) s.style.color = '#ffc107';
      });
    }
  </script>
  <% } %>

  <% if (session.userId === story.user_id) { %>
  <div class="story-actions button-group">
    <a href="../story/<%= story.username %>/<%= story.vanity %>/edit" class="btn btn-secondary">Edit Story</a>

    <a href="#" class="btn btn-secondary" onclick="event.preventDefault(); if (confirm('Delete this story?')) { document.getElementById('delete-form').submit(); }">
      Delete Story
    </a>

    <form id="delete-form" action="../story/<%= story.username %>/<%= story.vanity %>/delete" method="POST" style="display: none;"></form>
  </div>

  <% } %>

  <div class="chapters">
    <h3>Chapters</h3>

    <% if (session.userId === story.user_id) { %>
    <a href="../story/<%= story.username %>/<%= story.vanity %>/chapter/add" class="btn btn-primary mb-2">Add Chapter</a>
    <% } %>

    <% if (chapters && chapters.length > 0) { %>
    <ol class="chapter-list">
      <% chapters.forEach(chapter => { %>
      <li>
        <a href="../story/<%= story.username %>/<%= story.vanity %>/chapter/<%= chapter.chapter_num %>">
          <% if (chapter.title) { %>
          Chapter <%= chapter.chapter_num %>: <%= chapter.title %>
          <% } else { %>
          Chapter <%= chapter.chapter_num %>
          <% } %>
        </a>
        <span class="chapter-date">
          <%= new Date(chapter.created_at).toLocaleDateString() %>
        </span>

        <% if (session.userId === story.user_id) { %>
        <span class="chapter-actions" style="margin-left: 10px;">
          <a href="../story/<%= story.username %>/<%= story.vanity %>/chapter/<%= chapter.chapter_num %>/edit" class="btn btn-sm btn-secondary">Edit</a>

          <a href="#" class="btn btn-sm btn-secondary" onclick="event.preventDefault(); if (confirm('Delete this chapter?')) { document.getElementById('delete-chapter-<%= chapter.chapter_num %>').submit(); }">
            Delete
          </a>

          <form id="delete-chapter-<%= chapter.chapter_num %>" action="../story/<%= story.username %>/<%= story.vanity %>/chapter/<%= chapter.chapter_num %>/delete" method="POST" style="display: none;"></form>
        </span>
        <% } %>
      </li>
      <% }) %>
    </ol>
    <% } else { %>
    <p>No chapters available yet.</p>
    <% } %>
  </div>
</div>